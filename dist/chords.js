function transposition(n,r,s){var e=0,a=[];return n.forEach(function(n,o){var l=n;console.log(l),console.log("%d: %s",o,n),n=n.replace(/m?(sus|add|maj)?[0-9]?( *(-|\/))? *$/,""),console.log(n),a=_chords.indexOf(n)<0?_chordsFlat:_chords;var t=a.indexOf(n);if(s<0)if(t+s<0)var c=a[(a.length+t+s)%a.length];else var c=a[(t+s)%a.length];else var c=a[(t+s)%a.length];console.log(n),console.log(c);var h=c.length-n.length;console.log(h),r=r.slice(0,o+e)+'<span class="chords-highlighted">'+c+r.slice(o+e+n.length,o+e+l.length)+"</span>"+r.slice(o+e+l.length),console.log(r),e+='<span class="chords-highlighted">'.length+"</span>".length+h}),r}function array2string(n){var r="";return n.forEach(function(n,s){r+=n+"\n"}),r}function findChords(n){var r,s,n=n.replace(/\|/g," ").replace(/\t/g," ").replace(/\-/g," ").replace(/\//g," ").replace(/[\[\]']+/g," "),e=/^ *[A-Ga-g](#|b|&)?m?(sus|add|maj)?[0-9]?( *(-|\/) *[A-G](#|b)?)?( +[A-Ga-g](#|b|&)?m?(sus|add|maj)?[0-9]?( *(-|\/) *[A-G](#|b|&)?)? *)* *$/,a=/[A-Ga-g](#|b|&)?m?(sus|add|maj)?[0-9]?( *(-|\/) *[A-G](#|b|&)?)? *$/;return String(n).match(e)?(r=n.search(a),s=findChords(n.substr(0,r-1)),s[r]=n.substr(r).trim(),s):[]}function replaceWithTags(n,r){var s=0;return n.forEach(function(n,e){console.log("%d: %s",e,n),r=r.slice(0,e+s)+'<span class="chords-highlighted">'+r.slice(e+s,e+s+n.length)+"</span>"+r.slice(e+s+n.length),s+='<span class="chords-highlighted">'.length+"</span>".length}),r}var chords=function(){},_chords=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],_chordsFlat=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];chords.parse=function(n){for(var r=n.split(/\r\n|\r|\n/g),s=0;s<r.length;s++)r[s]=replaceWithTags(findChords(r[s]),r[s]);return array2string(r)},chords.shiftScale=function(n,r,s){for(var e=_chords.indexOf(r),a=_chords.indexOf(s),o=a-e,l=n.split(/\r\n|\r|\n/g),t=0;t<l.length;t++)l[t]=transposition(findChords(l[t]),l[t],o);return array2string(l)},chords.shiftScaleBy=function(n,r){for(var s=r,e=n.split(/\r\n|\r|\n/g),a=0;a<e.length;a++)e[a]=transposition(findChords(e[a]),e[a],s);return array2string(e)};