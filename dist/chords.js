function transposition(r,n,a){var s=0,e=[];return r.forEach(function(r,t){var l=r;r=r.replace(/m?\+?(sus|add|maj|dim|aug)?[0-9]?( *(-|\/))? *$/,""),e=_chords.indexOf(r)<0?_chordsFlat:_chords;var h=e.indexOf(r);if(a<0)if(h+a<0)var i=e[(e.length+h+a)%e.length];else var i=e[(h+a)%e.length];else var i=e[(h+a)%e.length];var c=i.length-r.length;n=n.slice(0,t+s)+'<span class="chords-highlighted">'+i+n.slice(t+s+r.length,t+s+l.length)+"</span>"+n.slice(t+s+l.length),s+='<span class="chords-highlighted">'.length+"</span>".length+c}),n}function transposition_new(r,n,a,s){var e=0,t=[];return r.forEach(function(r,l){var h=r;r=r.replace(/m?\+?(sus|add|maj|dim|aug)?[0-9]?( *(-|\/))? *$/,""),t="flat"===s?_chordsFlat:_chords;var i=null;if(i=_chordsFlat.indexOf(r)>-1?_chordsFlat.indexOf(r):_chords.indexOf(r),a<0)if(i+a<0)var c=t[(t.length+i+a)%t.length];else var c=t[(i+a)%t.length];else var c=t[(i+a)%t.length];var d=c.length-r.length;n=n.slice(0,l+e)+'<span class="chords-highlighted">'+c+n.slice(l+e+r.length,l+e+h.length)+"</span>"+n.slice(l+e+h.length),e+='<span class="chords-highlighted">'.length+"</span>".length+d}),n}function array2string(r){var n="";return r.forEach(function(r,a){n+=r+"\n"}),n}function findChords(r){var n,a,r=r.replace(/\|/g," ").replace(/\t/g," ").replace(/\-/g," ").replace(/\//g," ").replace(/\(/g," ").replace(/\)/g," ").replace(/\,/g," ").replace(/\s/g," ").replace(/[\[\]']+/g," "),s=/^ *[A-Ga-g](#|b|&)?m?\+?(sus|add|maj|dim|aug)?[0-9]?( *(-|\/) *[A-G](#|b)?)?( +[A-Ga-g](#|b|&)?m?\+?(sus|add|maj|dim|aug)?[0-9]?( *(-|\/) *[A-G](#|b|&)?)? *)* *$/,e=/[A-Ga-g](#|b|&)?m?\+?(sus|add|maj|dim|aug)?[0-9]?( *(-|\/) *[A-G](#|b|&)?)? *$/;return String(r).match(s)?(n=r.search(e),a=findChords(r.substr(0,n-1)),a[n]=r.substr(n).trim(),a):[]}function replaceWithTags(r,n){var a=0;return r.forEach(function(r,s){n=n.slice(0,s+a)+'<span class="chords-highlighted">'+n.slice(s+a,s+a+r.length)+"</span>"+n.slice(s+a+r.length),a+='<span class="chords-highlighted">'.length+"</span>".length}),n}var chords={},_chords=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],_chordsFlat=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];chords.parse=function(r){for(var n=r.split(/\r\n|\r|\n/g),a=0;a<n.length;a++)n[a]=replaceWithTags(findChords(n[a]),n[a]);return array2string(n)},chords.shiftScale=function(r,n,a,s){n=n.replace(/m?\+?(sus|add|maj|dim|aug)?[0-9]?( *(-|\/))? *$/,"").replace(" ","");var e=null,t=null;t="b"===a.substr(1,1)?_chordsFlat.indexOf(a):_chords.indexOf(a),e=_chords.indexOf(n)>-1?_chords.indexOf(n):_chordsFlat.indexOf(n);for(var l=t-e,h=r.split(/\r\n|\r|\n/g),i=0;i<h.length;i++)h[i]=transposition_new(findChords(h[i]),h[i],l,s);return array2string(h)},chords.shiftScaleBy=function(r,n){for(var a=n,s=r.split(/\r\n|\r|\n/g),e=0;e<s.length;e++)s[e]=transposition(findChords(s[e]),s[e],a);return array2string(s)};